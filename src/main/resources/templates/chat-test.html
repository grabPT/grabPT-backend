<!--<!DOCTYPE html>-->
<!--<html>-->
<!--<head>-->
<!--    <meta charset="UTF-8">-->
<!--    <title>ì‹¤ì‹œê°„ ì±„íŒ… í…ŒìŠ¤íŠ¸ (senderId only)</title>-->
<!--    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>-->
<!--    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>-->
<!--    <style>-->
<!--        body { font-family: 'Segoe UI', sans-serif; padding: 20px; }-->
<!--        #log { background: #f0f0f0; padding: 10px; height: 250px; overflow-y: auto; }-->
<!--        input { margin: 5px; }-->
<!--    </style>-->
<!--</head>-->
<!--<body>-->
<!--<h2>GrabPT ì‹¤ì‹œê°„ ì±„íŒ… í…ŒìŠ¤íŠ¸</h2>-->

<!--<label>Room ID:-->
<!--    <input type="number" id="roomId" value="1">-->
<!--</label><br>-->
<!--<label>Sender ID:-->
<!--    <input type="number" id="senderId" value="1001">-->
<!--</label><br>-->
<!--<button onclick="connect()">ì±„íŒ…ë°© ì…ì¥</button>-->

<!--<div style="margin-top: 10px;">-->
<!--    <input type="text" id="msg" placeholder="ë©”ì‹œì§€ ì…ë ¥" style="width: 300px;">-->
<!--    <button onclick="sendMsg()">ì „ì†¡</button>-->
<!--</div>-->

<!--<h3>ì±„íŒ… ë¡œê·¸</h3>-->
<!--<pre id="log"></pre>-->

<!--<script>-->
<!--    let stompClient = null;-->

<!--    function connect() {-->
<!--      const roomId = document.getElementById('roomId').value;-->
<!--      stompClient = Stomp.over(new SockJS("/ws-connect"));-->

<!--      stompClient.connect({}, function () {-->
<!--        log(`âœ… ì›¹ì†Œì¼“ ì—°ê²° ì™„ë£Œ. ë°© ë²ˆí˜¸: ${roomId}`);-->

<!--        // í•´ë‹¹ ë°© êµ¬ë…-->
<!--        stompClient.subscribe("/subscribe/chat/" + roomId, function (msg) {-->
<!--          const messageBody = JSON.parse(msg.body);-->
<!--          // ë‚´ senderIdì™€ ê°™ìœ¼ë©´ ë¡œê·¸ ì¶œë ¥ ìƒëµ-->
<!--        if (messageBody.senderId === Number(document.getElementById("senderId").value)) {-->
<!--            return; // ë‚´ê°€ ë³´ë‚¸ ë©”ì‹œì§€ëŠ” ì¶œë ¥í•˜ì§€ ì•ŠìŒ-->
<!--        }-->
<!--          log(`[ìˆ˜ì‹ ] senderId=${messageBody.senderId}: ${messageBody.content}`);-->
<!--        });-->
<!--      });-->
<!--    }-->

<!--    function sendMsg() {-->
<!--      const roomId = Number(document.getElementById('roomId').value);-->
<!--      const senderId = Number(document.getElementById('senderId').value);-->
<!--      const content = document.getElementById('msg').value;-->

<!--      if (!roomId || !senderId || !content) {-->
<!--        alert("roomId / senderId / content ëª¨ë‘ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.");-->
<!--        return;-->
<!--      }-->

<!--      stompClient.send("/publish/chat/" + roomId, {}, JSON.stringify({-->
<!--        roomId: roomId,-->
<!--        senderId: senderId,-->
<!--        content: content,-->
<!--        messageType: "TEXT"-->
<!--      }));-->

<!--      log(`[ë³´ëƒ„] ë‚˜(${senderId}): ${content}`);-->
<!--      document.getElementById('msg').value = '';-->
<!--    }-->

<!--    function log(text) {-->
<!--      const logBox = document.getElementById("log");-->
<!--      logBox.textContent += text + "\n";-->
<!--      logBox.scrollTop = logBox.scrollHeight;-->
<!--    }-->
<!--</script>-->
<!--</body>-->
<!--</html>-->
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>GrabPT ì‹¤ì‹œê°„ ì±„íŒ…</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.6.1/sockjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; }
        #chat-room-list button { display: block; margin: 5px 0; padding: 10px; width: 100%; }
        #chat-log { background: #f9f9f9; border: 1px solid #ccc; padding: 10px; height: 250px; overflow-y: scroll; margin-top: 10px; }
        .mine { text-align: right; color: green; }
        .other { text-align: left; color: black; }
    </style>
</head>
<body>

<h2>ğŸ™‹ ì±„íŒ…ë°© ë¦¬ìŠ¤íŠ¸</h2>
<div>
    <label>ì‚¬ìš©ì ID:
        <input type="number" id="senderId" value="1" />
    </label>
    <button onclick="loadChatRooms()">ì±„íŒ…ë°© ë¶ˆëŸ¬ì˜¤ê¸°</button>
</div>

<div id="chat-room-list"></div>

<hr>

<div id="chat-room" style="display: none;">
    <h3 id="chat-title">ì±„íŒ…ë°©</h3>
    <div id="chat-log"></div>

    <input type="text" id="msg-input" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”" />
    <button onclick="sendMsg()">ì „ì†¡</button>
</div>

<script>
    let stompClient = null;
    let currentRoomId = null;
    let senderId = null;

    // ì±„íŒ…ë°© ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
    async function loadChatRooms() {
        senderId = Number(document.getElementById("senderId").value);
        if (!senderId) {
            return alert("ì‚¬ìš©ì IDë¥¼ ì…ë ¥í•˜ì„¸ìš”!");
        }

        const res = await fetch(`/chatRoom/list?userId=${senderId}`);
        const result = await res.json();

        const list = document.getElementById("chat-room-list");
        list.innerHTML = "<h3>ë‚´ ì±„íŒ…ë°©</h3>";

        // âœ… ì‘ë‹µ êµ¬ì¡°ê°€ { isSuccess: true, result: [...] } ì¸ ê²½ìš°
        if (result.isSuccess) {
            const rooms = result.result;

            rooms.forEach(room => {
                const btn = document.createElement("button");
                btn.textContent = `ğŸ‘¤ ${room.roomName} - ${room.lastMessage || '(ëŒ€í™” ì—†ìŒ)'}`;

                // âœ… ì˜¬ë°”ë¥¸ chatRoomIdë¡œ ì „ì†¡
                btn.onclick = () => enterRoom(room.chatRoomId);

                list.appendChild(btn);
            });
        } else {
            alert("ì±„íŒ…ë°© ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
        }
    }

    // ì±„íŒ…ë°© ë“¤ì–´ê°€ê¸°
    async function enterRoom(roomId) {
        currentRoomId = roomId;

        // ì´ˆê¸°í™”
        document.getElementById("chat-title").textContent = `ì±„íŒ…ë°© #${roomId}`;
        document.getElementById("chat-log").innerHTML = "";
        document.getElementById("chat-room").style.display = "block";

        // ì´ì „ ë©”ì‹œì§€ ë¶ˆëŸ¬ì˜¤ê¸°
        const res = await fetch(`/chatRoom/${roomId}/messages`);
        const result = await res.json();

        if (result.isSuccess) {
            const messages = result.result;
            messages.forEach(msg => {
                appendMessage(msg.senderId, msg.content);
            });
        }

        // ì›¹ì†Œì¼“ ì—°ê²°
        connectSocket(roomId);
    }

    // ì›¹ì†Œì¼“ ì—°ê²° ë° êµ¬ë…
    function connectSocket(roomId) {
        if (stompClient && stompClient.connected) {
            stompClient.disconnect(() => console.log("ê¸°ì¡´ WebSocket ì—°ê²° í•´ì œë¨"));
        }

        const socket = new SockJS("/ws-connect");
        stompClient = Stomp.over(socket);

        stompClient.connect({}, () => {
            stompClient.subscribe(`/subscribe/chat/${roomId}`, function (msg) {
                const body = JSON.parse(msg.body);
                appendMessage(body.senderId, body.content);
            });
        });
    }

    // ë©”ì‹œì§€ ì „ì†¡
    function sendMsg() {
        const input = document.getElementById("msg-input");
        const content = input.value.trim();
        if (!content) return;

        const message = {
            roomId: currentRoomId,
            senderId: senderId,
            content: content,
            messageType: "TEXT"
        };

        stompClient.send(`/publish/chat/${currentRoomId}`, {}, JSON.stringify(message));
<!--        appendMessage(senderId, content); // ë‚´ ë©”ì‹œì§€ ì¦‰ì‹œ í‘œì‹œ-->
        input.value = '';
    }

    // ë©”ì‹œì§€ í™”ë©´ í‘œì‹œ
    function appendMessage(sender, content) {
        const log = document.getElementById("chat-log");
        const div = document.createElement("div");
        const isMine = sender === senderId;

        div.textContent = `${isMine ? "ğŸŸ¢ ë‚˜" : `ğŸ”µ ${sender}`}: ${content}`;
        div.className = isMine ? "mine" : "other";

        log.appendChild(div);
        log.scrollTop = log.scrollHeight;
    }
</script>


</body>
</html>

